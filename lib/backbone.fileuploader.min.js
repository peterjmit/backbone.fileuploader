/*!
 * backbone.fileuploader.js v0.2.0
 * Copyright 2013, Peter Mitchell (@peterjmit)
 * backbone.fileuploader.js may be distributed under the MIT licence
 */
!function(a){"use strict";var b=a.Backbone,c=a._,d=a.$,e="Files",f={};f.Model=b.Model.extend({defaults:{name:null,size:null,lastModifiedDate:null,type:null,data:null,isImage:!1,uploadProgress:0},browserFileObj:null,setFileObj:function(a){var b={};this.browserFileObj=a,c.each(this.defaults,function(c,d){var e=a[d];e&&(b[d]=e)}),c.extend(b,{isImage:!!a.type.match("image/*")}),this.set(b)},toJSON:function(){return{name:this.attributes.name}},parse:function(a){return a.result},_xhrProgressListener:function(){var b=d.ajaxSettings.xhr(),e=c.bind(function(a){var b=a.lengthComputable?Math.ceil(100*(a.loaded/a.total)):null;this.trigger("progress",this,b)},this);return(b instanceof a.XMLHttpRequest||b.upload)&&b.addEventListener("progress",e,!1),b},sync:function(a,d,e){return"create"===a&&this.browserFileObj&&c.extend(e,{data:this._buildForm(),processData:!1,contentType:!1,xhr:c.bind(this._xhrProgressListener,this)}),b.sync.apply(this,[a,d,e])},_buildForm:function(){var a=new FormData,b=this.toJSON();return c.each(b,function(b,c){a.append(c,b)}),a.append("file",this.browserFileObj),a}}),f.Collection=b.Collection.extend({model:f.Model}),f.View=b.View.extend({fileReaderEvents:{onloadstart:null,onprogress:null,onabort:null,onerror:null,onload:"onFileLoad",onloadend:null},constructor:function(a){a=a||{},this.bindEvents(a),b.View.call(this,a)},render:function(a){this.$el.html(this.options.template),a(this.el)},bindEvents:function(a){a=c.defaults(a,this.options),this.events=this.events||{},a.dragAndDrop&&(this.events.dragover="onDragOver",this.events.dragleave="onDragLeave",this.events.drop="onDrop"),this.events["change input[type=file]"]="onFormChange",a.paste&&(this.events.paste="onPaste")},onFormChange:function(a){a.stopPropagation(),a.preventDefault(),this.handleFiles(a.target.files)},onDragOver:function(a){a.stopPropagation(),a.preventDefault(),this.$el.addClass(this.options.dragOverClass),a.originalEvent.dataTransfer.dropEffect="copy"},onDragLeave:function(a){a.stopPropagation(),a.preventDefault(),this.$el.removeClass(this.options.dragOverClass)},onDrop:function(a){a.stopPropagation(),a.preventDefault(),this.handleFiles(a.originalEvent.dataTransfer.files)},onPaste:function(a){var b=[],d=a.originalEvent.clipboardData;a.stopPropagation(),a.preventDefault(),c.each(d.types,function(a,c){a===e&&b.push(d.items[c].getAsFile())},this),this.handleFiles(b)},handleFiles:function(a){c.each(a,this.handleFile,this)},handleFile:function(a){var b=new this.collection.model;b.setFileObj(a),this.collection.add(b),this.options.saveOnAdd&&b.save(),b.get("isImage")&&this.options.readImageFiles&&this.readFile(b)},readFile:function(a){var b=new FileReader,d=c.result(this,"fileReaderEvents");c.each(d,function(d,e){d&&(d=this[d])&&(b[e]=c.bind(d,this,a))},this),b.readAsDataURL(a.browserFileObj)},onFileLoad:function(a,b){a.set({data:b.target.result})}}),f.View.prototype.options={dragAndDrop:!0,readImageFiles:!0,saveOnAdd:!1,paste:!1,dragOverClass:"drop-area",template:'<input type="file" name="files[]" multiple />'},b.FileUploader=f}("object"==typeof global?global:this);
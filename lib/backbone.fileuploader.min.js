/*!
 * backbone.fileuploader.js v0.1.0
 * Copyright 2013, Peter Mitchell (@peterjmit)
 * backbone.fileuploader.js may be distributed under the MIT licence
 */
(function(e){"use strict";var t=e.Backbone,n=e._;e.$;var a="Files",i={};i.Model=t.Model.extend({defaults:{name:null,size:null,lastModifiedDate:null,type:null,data:null,isImage:!1,uploadProgress:0},browserFileObj:null,setFileObj:function(e){var t={};this.browserFileObj=e,n.each(this.defaults,function(n,a){var i=e[a];i&&(t[a]=i)}),n.extend(t,{isImage:!!e.type.match("image/*")}),this.set(t)},toJSON:function(){var e=n.clone(this.attributes);return delete e.data,delete e.uploadProgress,delete e.isImage,e},parse:function(e){return e.result},sync:function(e,a,i){return"create"===e&&this.browserFileObj&&n.extend(i,{data:this._buildForm(),processData:!1,contentType:!1}),t.sync.apply(this,[e,a,i])},_buildForm:function(){var e=new FormData,t=this.toJSON();return n.each(t,function(t,n){e.append(n,t)}),e.append("file",this.browserFileObj),e}}),i.Collection=t.Collection.extend({model:i.Model}),i.View=t.View.extend({fileReaderEvents:{onloadstart:null,onprogress:null,onabort:null,onerror:null,onload:"onFileLoad",onloadend:null},constructor:function i(e){e=e||{},this.bindEvents(e),t.View.call(this,e)},render:function(e){this.$el.html(this.options.template),e(this.el)},bindEvents:function(e){e=n.defaults(e,this.options),this.events=this.events||{},e.dragAndDrop&&(this.events.dragover="onDragOver",this.events.dragleave="onDragLeave",this.events.drop="onDrop"),this.events["change input[type=file]"]="onFormChange",e.paste&&(this.events.paste="onPaste")},onFormChange:function(e){e.stopPropagation(),e.preventDefault(),this.handleFiles(e.target.files)},onDragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.addClass(this.options.dragOverClass),e.originalEvent.dataTransfer.dropEffect="copy"},onDragLeave:function(e){e.stopPropagation(),e.preventDefault(),this.$el.removeClass(this.options.dragOverClass)},onDrop:function(e){e.stopPropagation(),e.preventDefault(),this.handleFiles(e.originalEvent.dataTransfer.files)},onPaste:function(e){var t=[],i=e.originalEvent.clipboardData;e.stopPropagation(),e.preventDefault(),n.each(i.types,function(e,n){e===a&&t.push(i.items[n].getAsFile())},this),this.handleFiles(t)},handleFiles:function(e){n.each(e,this.handleFile,this)},handleFile:function(e){var t=new this.collection.model;t.setFileObj(e),this.collection.add(t),this.options.saveOnAdd&&t.save(),t.get("isImage")&&this.options.readImageFiles&&this.readFile(t)},readFile:function(e){var t=new FileReader,a=n.result(this,"fileReaderEvents");n.each(a,function(a,i){a&&(a=this[a])&&(t[i]=n.bind(a,this,e))},this),t.readAsDataURL(e.browserFileObj)},onFileLoad:function(e,t){e.set({data:t.target.result})}}),i.View.prototype.options={dragAndDrop:!0,readImageFiles:!0,saveOnAdd:!1,paste:!1,dragOverClass:"drop-area",template:'<input type="file" name="files[]" multiple />'},t.FileUploader=i})("object"==typeof global?global:this);